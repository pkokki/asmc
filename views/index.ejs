<!DOCTYPE html>
<html ng-app="app" ng-controller="AppController">
<head>
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/app.css" />
</head>
<body>

<div ui-view></div>

<!-- Libraries -->
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular-animate.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular-aria.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular-resource.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-router/0.2.13/angular-ui-router.min.js"></script>
	
<!-- Templates -->
<script type="text/ng-template" id="/index.html">
	<h3>API routes</h3>
	<ul>
		<li><a href="/api/spaces">api/spaces</a></li>
	</ul>
	<h3>Client routes</h3>
	<ul>
		<li><a href="#/">Home</a></li>
		<li><a href="#/spaces">Spaces</a></li>
	</ul>
</script>

<script type="text/ng-template" id="/spaceList.html">
	Search: <input type="text" ng-model="search.name">
  
	<div class="table-responsive-vertical shadow-z-1">
	<table class="table table-hover">
	<thead>
		<tr>
		  <th>Name</th>
		  <th>Description</th>
		  <th>A</th>
		</tr>
	</thead>
	<tbody>
		<tr ng-repeat="space in spaces | filter: search">
			<td data-title="Name">
				<a ng-show="!editing[$index]" href="#/spaces/{{space._id}}">{{space.name}}</a>
				<input ng-show="editing[$index]" type="text" ng-model="space.name">
			</td>
			<td data-title="Description">
				<input type="checkbox" ng-model="space.completed" ng-change="update($index)">
			</td>
			<td data-title="Actions">
				<button ng-show="!editing[$index]" ng-click="edit($index)">edit</button>
				<button ng-show="editing[$index]" ng-click="update($index)">Update</button>
				<button ng-show="editing[$index]" ng-click="cancel($index)">Cancel</button>
			</td>
		</tr>
	</tbody>
	</table>
	</div>

	New space <input type="text" ng-model="newSpace.name"><button ng-click="save()">Create</button>
</script>

<script type="text/ng-template" id="/spaceItem.html">
	Item
</script>

<script>
	angular.module('app', ['ui.router', 'ngResource'])
	
	//---------------
    // Services
    //---------------
    .factory('Spaces', ['$resource', function($resource){
		return $resource('/api/spaces/:id', null, {
			'update': { method:'PUT' }
		});
    }])
	
	//---------------
    // Controllers
    //---------------
	.controller('AppController', ['$scope', '$log', function($scope, $log) {
		$log.info('App started');
	}])
	
	.controller('SpaceListController', ['$scope', 'Spaces', function ($scope, Spaces) {
		$scope.spaces = Spaces.query();
		$scope.editing = [];
		$scope.save = function(){
			if(!$scope.newSpace.name || $scope.newSpace.name.length < 1) 
				return;
			var space = new Spaces($scope.newSpace);
			space.$save(function(){
				$scope.spaces.push(space);
				$scope.newSpace = {}; // clear values
			});
		}
		
		$scope.update = function(index){
			var space = $scope.spaces[index];
			Spaces.update({id: space._id}, space);
			$scope.editing[index] = false;
		}
		
		$scope.edit = function(index){
			$scope.editing[index] = angular.copy($scope.spaces[index]);
		}
		
		$scope.cancel = function(index){
			$scope.spaces[index] = angular.copy($scope.editing[index]);
			$scope.editing[index] = false;
		}
    }])
	
	.controller('SpaceItemController', ['$scope', '$location', '$stateParams', 'Spaces', function ($scope, $location, $stateParams, Spaces) {
		$scope.space = Spaces.get({id: $stateParams.id });
		$scope.update = function(){
			Spaces.update({id: $scope.space._id}, $scope.space, function(){
				$location.url('/spaces');
			});
		}
    }])
	
	//---------------
    // Routes
    //---------------
    .config(['$stateProvider', '$urlRouterProvider', function ($stateProvider, $urlRouterProvider) {
		$urlRouterProvider.otherwise('/home');
		
		$stateProvider
			.state('home', {
				url: '/home',
				templateUrl: '/index.html',
			})
			.state('spaceList', {
				url: '/spaces',
				templateUrl: '/spaceList.html',
				controller: 'SpaceListController'
			})
			.state('spaceItem', {
				url: '/spaces/:id',
				templateUrl: '/spaceItem.html',
				controller: 'SpaceItemController'
			})
		;
	}]);
</script>

</body>
</html>